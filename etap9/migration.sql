CREATE TABLE "invoice_order_item" (
    "invoice_order_item_id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "invoice_id" INTEGER NOT NULL,
    "order_item_id" INTEGER NOT NULL,
    PRIMARY KEY("invoice_order_item_id"),
    CONSTRAINT "fk_invoice_order_item_invoice"
        FOREIGN KEY("invoice_id")
        REFERENCES "invoice"("id")
        ON DELETE CASCADE,

    CONSTRAINT "fk_invoice_order_item_item"
        FOREIGN KEY("order_item_id")
        REFERENCES "order_item"("order_item_id")
        ON DELETE RESTRICT,

    CONSTRAINT "uq_invoice_item_pair"
        UNIQUE("invoice_id", "order_item_id")

);

INSERT INTO "invoice_order_item" ("invoice_id", "order_item_id")
SELECT
    i."id",
    oi."order_item_id"
FROM "invoice" i
JOIN "order_item" oi ON i."order_id" = oi."order_id";

ALTER TABLE "invoice"
DROP COLUMN "order_id";
